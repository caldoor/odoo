<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <template id="assets_frontend" inherit_id="web.assets_frontend">
        <xpath expr="script[last()]" position="after">
            <script type="text/javascript" src="/caldoor_authorize/static/src/js/payment.js"></script>
        </xpath>
    </template>

    <template inherit_id="payment.payment_tokens_list" id="payment_tokens_list">
        <xpath expr="//div[hasclass('card')]" position="inside">
            <t t-if="sale_order">
              <t t-set="amount_credit" t-value="sale_order.partner_id._get_outstanding_credit()"/>
            </t>
            <t t-elif="invoice">
              <t t-set="amount_credit" t-value="invoice.partner_id._get_outstanding_credit()"/>
            </t>
            <t t-else="">
              <t t-set="amount_credit" t-value="0.00"/>
            </t>
            <t t-if="isinstance(acquirers, (list))">
              <t t-set="authorize" t-value="[acq for acq in acquirers if acq.provider == 'authorize']"/>
            </t>
            <t t-else="">
              <t t-set="authorize" t-value="acquirers.filtered(lambda a: a.provider == 'authorize')"/>
            </t>
            <t t-if="not authorize">
              <t t-set="authorize" t-value="pms.filtered(lambda p: p.provider == 'authorize')"/>
            </t>
            <t t-if="authorize and sale_order and not sale_order.has_convenience_fee_applied()">
                <input type="hidden" t-att-value="fee" name="convenience_fee" id="convenience_fee"/>
                <input type="hidden" t-att-value="sale_order.id" name="sale_order_id" id="sale_order_id"/>
                <div class="card-body convenience_fee" style="display: none;">
                    <div class="alert alert-info">
                        <t t-set="amount" t-value="sale_order.amount_total"/>
                        <t t-set="order_amount" t-value="sale_order.amount_total - amount_credit"/>
                        <t t-set="c100_fee" t-options="{'widget': 'float', 'precision': 2}" t-value="((authorize[0].convenience_fee_percent * (order_amount))/100)"/>
                        <t t-set="c50_fee" t-options="{'widget': 'float', 'precision': 2}" t-value="((authorize[0].convenience_fee_percent * (order_amount/ 2)) /100)"/>
                        <t t-if="sale_order.payment_term_id.is_c50_term">
                            <div style="background-color: whitesmoke;">
                                <label class="ml8"> <input type="checkbox" class="payment_choice" value="c50"/> <span class="badge">50% Payment</span></label>
                                <label class="ml8"> <input type="checkbox" checked="checked" class="payment_choice" value="c100"/> <span class="badge">100% Payment</span></label>
                            </div>
                        </t>
                        <p><small>Convenience fee details for authorize payment</small></p>
                        <table class="table table-bordered" style="width: 60%;">
                            <tr t-if="amount_credit > 0.00">
                                <td style="padding:5px;">Outstanding Credit</td>
                                <td class="text-right" style="padding:5px;">
                                    <span class="amount_credit" style="color: #FF0000; font-weight: bold;">
                                        (<t t-esc="amount_credit"/>)
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding:5px;">Order Amount</td>
                                <td class="text-right" style="padding:5px;"><span class="c100_term_field"><t t-esc="amount"/></span><span class="c50_term_field d-none"><t t-options="{'widget': 'float', 'precision': 2}" t-esc="amount / 2"/></span></td>
                            </tr>
                            <tr>
                                <td style="padding:5px;">Convenience Fee</td>
                                <td class="text-right" style="padding:5px;"><span class="c100_term_field"><t t-esc="c100_fee" t-options="{'widget': 'float', 'precision': 2}"/></span><span class="c50_term_field d-none"><t t-esc="c50_fee" t-options="{'widget': 'float', 'precision': 2}"/></span></td>
                            </tr>
                            <tr style="background-color: whitesmoke;">
                                <td style="padding:5px;">Total Payable Amount</td>
                                <td class="text-right" style="padding:5px;"><b><span class="c100_term_field"><t t-options="{'widget': 'float', 'precision': 2}" t-esc="(order_amount + c100_fee)"/></span><span class="c50_term_field d-none"><t t-options="{'widget': 'float', 'precision': 2}" t-esc="(order_amount / 2 + c50_fee)"/></span></b></td>
                            </tr>
                        </table>
                        <div style="background-color: whitesmoke;">
                            <small class="ml8"><b>Do you want to proceed ?</b></small>
                            <label class="ml8"> <input type="checkbox" class="fee_decision" name="fee_decision" value="yes"/> <span class="badge">Yes</span></label>
                            <label class="ml8"> <input type="checkbox" class="fee_decision" name="fee_decision" value="no"/> <span class="badge">No</span></label>
                        </div>
                    </div>
                </div>
            </t>
        </xpath>
        <xpath expr="//t[@t-foreach='pms']//input[@name='pm_id']" position="attributes">
            <attribute name="t-att-data-provider">pm.provider</attribute>
        </xpath>
        <xpath expr="//div[@class='card-body']/button[@name='delete_pm']" position="replace">
            <t t-if="not partner_page">
                <button t-if="mode == 'manage'" name="delete_pm" t-att-value="pm.id" class="btn btn-primary btn-sm float-right">
                    <i class="fa fa-trash"></i> Delete
                </button>
            </t>
        </xpath>
    </template>
    <template inherit_id="sale.sale_order_portal_template" id="sale_order_portal_template">
        <xpath expr="//div[@t-if='pms or acquirers']" position="before">
            <t t-set="acquirers" t-value="acquirers.sudo().filtered(lambda aq: request.env.user not in aq.restricted_group_ids.mapped('users'))"/>
        </xpath>
        <xpath expr="//div[@id='payment_method']" position="after">
            <div t-if="not (pms or acquirers)">
                <H4>There are no payment tokens available for this customer.</H4>
            </div>
        </xpath>
    </template>
    <template id="portal_invoice_page_inherit_caldoor_authorize" name="Payment on My Invoices" inherit_id="account.portal_invoice_page">
        <xpath expr="//div[@t-if='pms or acquirers']" position="before">
            <t t-set="acquirers" t-value="acquirers.sudo().filtered(lambda aq: request.env.user not in aq.restricted_group_ids.mapped('users'))"/>
        </xpath>
        <xpath expr="//div[@id='payment_method']" position="replace">
            <div id="payment_method">
                <t t-call="account_payment.portal_invoice_payment"/>
            </div>
        </xpath>
    </template>
    <template id="portal_invoice_payment_inherit_caldoor_authorize" inherit_id="account_payment.portal_invoice_payment">
        <xpath expr="//div[@id='payment_method']" position="after">
            <div t-if="not (pms or acquirers)">
                <H4>There are no payment tokens available for this customer.</H4>
            </div>
        </xpath>
    </template>
</odoo>